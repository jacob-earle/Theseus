<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="An implementation of an allocator that uses multiple heaps. The heap that will be used on each allocation is determined by a key. Right now we use the apic id as the key, so that we have per-core heaps."><meta name="keywords" content="rust, rustlang, rust-lang, multiple_heaps"><title>multiple_heaps - Rust</title><link rel="stylesheet" type="text/css" href="../normalize.css"><link rel="stylesheet" type="text/css" href="../rustdoc.css" id="mainThemeStyle"><link rel="stylesheet" type="text/css" href="../light.css"  id="themeStyle"><link rel="stylesheet" type="text/css" href="../dark.css" disabled ><link rel="stylesheet" type="text/css" href="../ayu.css" disabled ><script id="default-settings"></script><script src="../storage.js"></script><script src="../crates.js"></script><noscript><link rel="stylesheet" href="../noscript.css"></noscript><link rel="icon" type="image/svg+xml" href="../favicon.svg">
<link rel="alternate icon" type="image/png" href="../favicon-16x16.png">
<link rel="alternate icon" type="image/png" href="../favicon-32x32.png"><style type="text/css">#crate-search{background-image:url("../down-arrow.svg");}</style></head><body class="rustdoc mod"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="sidebar"><div class="sidebar-menu" role="button">&#9776;</div><a href='../multiple_heaps/index.html'><div class='logo-container rust-logo'><img src='../rust-logo.png' alt='logo'></div></a><p class="location">Crate multiple_heaps</p><div class="block version"><p>Version 0.1.0</p></div><div class="sidebar-elems"><a id="all-types" href="all.html"><p>See all multiple_heaps's items</p></a><div class="block items"><ul><li><a href="#structs">Structs</a></li><li><a href="#constants">Constants</a></li><li><a href="#functions">Functions</a></li></ul></div><p class="location"></p><div id="sidebar-vars" data-name="multiple_heaps" data-ty="mod" data-relpath="../"></div><script defer src="../sidebar-items.js"></script></div></nav><div class="theme-picker"><button id="theme-picker" aria-label="Pick another theme!" aria-haspopup="menu"><img src="../brush.svg" width="18" height="18" alt="Pick another theme!"></button><div id="theme-choices" role="menu"></div></div><nav class="sub"><form class="search-form"><div class="search-container"><div><select id="crate-search"><option value="All crates">All crates</option></select><input class="search-input" name="search" disabled autocomplete="off" spellcheck="false" placeholder="Click or press ‘S’ to search, ‘?’ for more options…" type="search"></div><button type="button" id="help-button">?</button>
                <a id="settings-menu" href="../settings.html"><img src="../wheel.svg" width="18" height="18" alt="Change settings"></a></div></form></nav><section id="main" class="content"><h1 class="fqn"><span class="in-band">Crate <a class="mod" href="">multiple_heaps</a><button id="copy-path" onclick="copy_path(this)"><img src="../clipboard.svg" width="19" height="18" alt="Copy item import"></button></span><span class="out-of-band"><span id="render-detail"><a id="toggle-all-docs" href="javascript:void(0)" title="collapse all docs">[<span class="inner">&#x2212;</span>]</a></span><a class="srclink" href="../src/multiple_heaps/lib.rs.html#1-647" title="goto source code">[src]</a></span></h1><details class="rustdoc-toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>An implementation of an allocator that uses multiple heaps. The heap that will be used on each allocation is determined by a key.
Right now we use the apic id as the key, so that we have per-core heaps.</p>
<p>The heaps are ZoneAllocators (given in the slabmalloc crate). Each ZoneAllocator maintains 11 separate “slab allocators” for sizes
8, 16, 32, 64, 128, 256, 512, 1024, 2048, 4096 and (8KiB - bytes of metadata) bytes. The maximum allocation size is given by <code>ZoneAllocator::MAX_ALLOC_SIZE</code>.
The slab allocator maintains linked lists of allocable pages from which it allocates objects of the same size. 
The allocable pages are 8 KiB (<code>ObjectPage8k::SIZE</code>), and have metadata stored in the ending bytes (<code>ObjectPage8k::METADATA_SIZE</code>).
The metadata includes a heap id, MappedPages object this allocable page belongs to, forward and back pointers to pages stored in a linked list and a
bitmap to keep track of allocations. The maximum allocation size can change if the size of the objects in the metadata change. If that happens it will be automatically
reflected in the constants <code>ZoneAllocator::MAX_ALLOC_SIZE</code> and <code>ObjectPage8k::METADATA_SIZE</code></p>
<p>Any memory request greater than maximum allocation size, a large allocation, is satisfied through a request for pages from the kernel.
All other requests are satisfied through the per-core heaps.</p>
<p>The per-core heap which will be used on allocation is determined by the cpu that the task is running on.
On deallocation of a block, the heap id is retrieved from metadata at the end of the allocable page which contains the block.</p>
<p>When a per-core heap runs out of memory, pages are first moved between the slab allocators of the per-core heap, then requested from other per-core heaps.
If no empty pages are available within any of the per-core heaps, then more virtual pages are allocated from the range of virtual addresses dedicated to the heap
<a href="../kernel_config/memory/constant.KERNEL_HEAP_START.html">KERNEL_HEAP_START</a> and dynamically mapped to physical memory frames.</p>
</div></details><h2 id="structs" class="section-header"><a href="#structs">Structs</a></h2>
<table><tr class="module-item"><td><a class="struct" href="struct.MultipleHeaps.html" title="multiple_heaps::MultipleHeaps struct">MultipleHeaps</a></td><td class="docblock-short"><p>An allocator that contains multiple heaps. The heap that is used on each allocation is
determined by a key. Currently the apic id is used as the key.</p>
</td></tr></table><h2 id="constants" class="section-header"><a href="#constants">Constants</a></h2>
<table><tr class="module-item"><td><a class="constant" href="constant.PER_CORE_HEAP_INITIAL_SIZE_PAGES.html" title="multiple_heaps::PER_CORE_HEAP_INITIAL_SIZE_PAGES constant">PER_CORE_HEAP_INITIAL_SIZE_PAGES</a></td><td class="docblock-short"><p>Starting size of each per-core heap. </p>
</td></tr></table><h2 id="functions" class="section-header"><a href="#functions">Functions</a></h2>
<table><tr class="module-item"><td><a class="fn" href="fn.init_individual_heap.html" title="multiple_heaps::init_individual_heap fn">init_individual_heap</a></td><td class="docblock-short"><p>Initializes the heap given by <code>key</code>.
There are 11 size classes in each heap ranging from [8,16,32,64 ..<code>ZoneAllocator::MAX_ALLOC_SIZE</code>].
We evenly distribute the pages allocated for each heap between the size classes. </p>
</td></tr><tr class="module-item"><td><a class="fn" href="fn.switch_to_multiple_heaps.html" title="multiple_heaps::switch_to_multiple_heaps fn">switch_to_multiple_heaps</a></td><td class="docblock-short"><p>The setup routine for multiple heaps. It creates and initializes the multiple heaps,
then sets the multiple heaps as the default allocator.
Only call this function when the multiple heaps are ready to be used.</p>
</td></tr></table></section><section id="search" class="content hidden"></section><div id="rustdoc-vars" data-root-path="../" data-current-crate="multiple_heaps" data-search-index-js="../search-index.js" data-search-js="../search.js"></div>
    <script src="../main.js"></script></body></html>